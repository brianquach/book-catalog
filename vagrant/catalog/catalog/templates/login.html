{% extends "layout.html" %}

{% block title %} Login {% endblock %}
{% block head %}
<script src="https://apis.google.com/js/client:platform.js?onload=start" async defer /></script>
<script>
    function start() {
        gapi.load(
            'auth2',
            function() {
                auth2 = gapi.auth2.init({
                    client_id: '{{client_id}}',
                    scope: 'openid email'
                });
            }
        );
    }
</script>
{% endblock %}

{% block content %}
<button id="signinButton">Sign in with Google</button>
{% endblock %}

{% block scripts %}
<script>
    $('#signinButton').click(function() {
        auth2.grantOfflineAccess({'redirect_uri': 'postmessage'}).then(signInCallback);
    });

    function signInCallback(authResult, state) {
        if (authResult['code']) {
            // Hide the sign-in button now that the user is authorized, for example:
            $('#signinButton').attr('style', 'display: none');

            // Send the code to the server
            $.ajax({
                type: 'POST',
                url: 'http://localhost:8000/server-connect?state={{state}}',
                contentType: 'application/octet-stream; charset=utf-8',
                success: function(result) {
                    console.log(result);
                },
                processData: false,
                data: authResult['code']
            });
        } else {
            alert('authorization denied by user.')
        }
    }
</script>
{% endblock %}